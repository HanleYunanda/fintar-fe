<div class="role-container">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <p-card>
        <ng-template pTemplate="header">
            <div class="flex justify-between items-center p-4">
                <h2 class="text-xl font-semibold m-0">Role Management</h2>
                <p-button label="Create Role" icon="pi pi-plus" (click)="openCreateDialog()"
                    severity="success"></p-button>
            </div>
        </ng-template>

        <p-table [value]="roles()" [loading]="loading()" [paginator]="true" [rows]="10"
            [rowsPerPageOptions]="[5, 10, 20]" [globalFilterFields]="['name']" class="p-datatable-sm"
            [tableStyle]="{ 'min-width': '50rem' }">

            <ng-template pTemplate="caption">
                <div class="flex justify-between items-center">
                    <span class="p-input-icon-left w-full md:w-auto">
                        <i class="pi pi-search me-3"></i>
                        <input pInputText type="text" placeholder="Search roles..." class="w-full md:w-80" />
                    </span>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="name" style="width: 60%">
                        Role Name <p-sortIcon field="name"></p-sortIcon>
                    </th>
                    <th style="width: 40%">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-role>
                <tr>
                    <td>{{ role.name }}</td>
                    <td>
                        <div class="flex gap-2">
                            <p-button icon="pi pi-key" [rounded]="true" [text]="true" severity="info"
                                (click)="openPermissionDialog(role)" pTooltip="Manage Permissions"
                                tooltipPosition="top"></p-button>
                            <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="warn"
                                (click)="openEditDialog(role)" pTooltip="Edit" tooltipPosition="top"></p-button>
                            <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                                (click)="deleteRole(role)" pTooltip="Delete" tooltipPosition="top"></p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="2" class="text-center py-8">
                        <i class="pi pi-shield text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500">No roles found</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>

    <!-- Create/Edit Dialog -->
    <p-dialog [header]="dialogMode() === 'create' ? 'Create Role' : 'Edit Role'" [(visible)]="dialogVisible"
        [modal]="true" [style]="{ width: '450px' }" [draggable]="false" [resizable]="false">
        <div class="flex flex-col gap-4 py-4">
            <div class="flex flex-col gap-2">
                <label for="roleName" class="font-semibold">Role Name</label>
                <input pInputText id="roleName" [value]="roleForm().name"
                    (input)="updateFormField('name', $any($event.target).value)" placeholder="Enter role name"
                    class="w-full" />
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button label="Cancel" severity="secondary" (click)="closeDialog()" [text]="true"></p-button>
            <p-button [label]="dialogMode() === 'create' ? 'Create' : 'Update'" (click)="saveRole()"
                [loading]="loading()"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Assign Permissions Dialog -->
    <p-dialog header="Manage Permissions" [(visible)]="permissionDialogVisible" [modal]="true"
        [style]="{ width: '600px' }" [draggable]="false" [resizable]="false">
        <div class="flex flex-col gap-4 py-4">
            <div class="flex flex-col gap-2">
                <label class="font-semibold">Select Permissions for "{{ selectedRole()?.name }}"</label>

                <div class="border border-gray-300 rounded-md p-4 max-h-96 overflow-y-auto">
                    @if (permissions().length === 0) {
                    <p class="text-gray-500 text-center py-4">Loading permissions...</p>
                    } @else {
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        @for (permission of permissions(); track permission.id) {
                        <div class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
                            <p-checkbox [binary]="true" [ngModel]="isPermissionSelected(permission.code)"
                                (ngModelChange)="togglePermission(permission.code)" [inputId]="'perm-' + permission.id">
                            </p-checkbox>
                            <label [for]="'perm-' + permission.id" class="cursor-pointer flex-1">
                                <div class="font-medium text-sm">{{ permission.code }}</div>
                            </label>
                        </div>
                        }
                    </div>
                    }
                </div>

                <div class="text-sm text-gray-600 mt-2">
                    Selected: <span class="font-semibold">{{ selectedPermissions().length }}</span> permission(s)
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button label="Cancel" severity="secondary" (click)="closePermissionDialog()" [text]="true"></p-button>
            <p-button label="Assign Permissions" (click)="assignPermissions()" [loading]="loading()"></p-button>
        </ng-template>
    </p-dialog>
</div>